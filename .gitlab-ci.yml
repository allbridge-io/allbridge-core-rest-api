stages:
  - validate
  - security
  - release
  - build
  - publish
  - scan

variables:
  NODE_VERSION: "22"
  NODE_IMAGE: "node:$NODE_VERSION-alpine"
  PNPM_HOME: "$CI_PROJECT_DIR/.pnpm-store"
  SDK_VERSION: "latest"
  DOCKER_IMAGE: "allbridge/io.allbridge.rest-api"
  TRIVY_IMAGE: "aquasec/trivy:0.58.2"
  # Security scan configuration
  # Scan depth: "none" | "minimal" | "standard" | "full"
  #   none     - skip all security scans
  #   minimal  - dependency scan only
  #   standard - dependency + secrets + container (default)
  #   full     - all scans including IaC/misconfig
  SECURITY_SCAN_LEVEL: "standard"
  SECURITY_SEVERITY: "CRITICAL,HIGH"
  SECURITY_FAIL_ON_VULN: "false"

default:
  image: $NODE_IMAGE
  interruptible: true
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store/
    policy: pull
    when: on_success

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always
    - if: '$CI_COMMIT_BRANCH == "alpha"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "beta"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: always
    - when: never

# STAGE: validate
lint:
  stage: validate
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store/
    policy: pull-push
  before_script:
    - corepack enable pnpm
    - pnpm config set store-dir $PNPM_HOME
  script:
    - pnpm --filter rest-api install --frozen-lockfile
    - pnpm --filter rest-api lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'

test:
  stage: validate
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store/
    policy: pull-push
  before_script:
    - corepack enable pnpm
    - pnpm config set store-dir $PNPM_HOME
  script:
    - pnpm --filter rest-api install --frozen-lockfile
    - pnpm --filter rest-api test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'
  allow_failure: true

# STAGE: security
# Trivy base template for security scans
.trivy-base:
  image:
    name: $TRIVY_IMAGE
    entrypoint: [""]
  variables:
    TRIVY_CACHE_DIR: ".trivycache/"
  cache:
    key: trivy-cache
    paths:
      - .trivycache/
    policy: pull-push
  before_script:
    - trivy --version

# Dependency vulnerability scanning (npm/pnpm packages)
dependency_scanning:
  extends: .trivy-base
  stage: security
  script:
    - |
      EXIT_CODE=0
      if [ "$SECURITY_FAIL_ON_VULN" = "true" ]; then
        EXIT_CODE=1
      fi
    - |
      trivy fs \
        --format template \
        --template "@/contrib/gitlab.tpl" \
        --output gl-dependency-scanning-report.json \
        --scanners vuln \
        --severity "$SECURITY_SEVERITY" \
        --exit-code $EXIT_CODE \
        .
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    when: always
    expire_in: 90 days
  rules:
    - if: $SCAN_DEPENDENCIES == "true"
    - if: $SCAN_DEPENDENCIES == "false"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "none"
      when: never
    - if: $SECURITY_SCAN_LEVEL =~ /^(minimal|standard|full)$/
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'

# Secret detection in codebase
secret_detection:
  extends: .trivy-base
  stage: security
  script:
    - |
      EXIT_CODE=0
      if [ "$SECURITY_FAIL_ON_VULN" = "true" ]; then
        EXIT_CODE=1
      fi
    - |
      trivy fs \
        --format template \
        --template "@/contrib/gitlab.tpl" \
        --output gl-secret-detection-report.json \
        --scanners secret \
        --exit-code $EXIT_CODE \
        .
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    when: always
    expire_in: 90 days
  rules:
    - if: $SCAN_SECRETS == "true"
    - if: $SCAN_SECRETS == "false"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "none"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "minimal"
      when: never
    - if: $SECURITY_SCAN_LEVEL =~ /^(standard|full)$/
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'

# IaC and Dockerfile misconfiguration scanning
iac_scanning:
  extends: .trivy-base
  stage: security
  script:
    - |
      EXIT_CODE=0
      if [ "$SECURITY_FAIL_ON_VULN" = "true" ]; then
        EXIT_CODE=1
      fi
    - |
      trivy config \
        --format template \
        --template "@/contrib/gitlab.tpl" \
        --output gl-sast-report.json \
        --severity "$SECURITY_SEVERITY" \
        --exit-code $EXIT_CODE \
        .
  artifacts:
    reports:
      sast: gl-sast-report.json
    when: always
    expire_in: 90 days
  rules:
    - if: $SCAN_IAC == "true"
    - if: $SCAN_IAC == "false"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "none"
      when: never
    - if: $SECURITY_SCAN_LEVEL =~ /^(minimal|standard)$/
      when: never
    - if: $SECURITY_SCAN_LEVEL == "full"
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'

# STAGE: release
release:
  stage: release
  dependencies: [lint]
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store/
    policy: pull
  variables:
    GIT_AUTHOR_NAME: "GitLab CI"
    GIT_AUTHOR_EMAIL: "ci@allbridge.io"
    GIT_COMMITTER_NAME: "GitLab CI"
    GIT_COMMITTER_EMAIL: "ci@allbridge.io"
  before_script:
    - apk add --no-cache git
    - corepack enable pnpm
    - pnpm config set store-dir $PNPM_HOME
  script:
    - pnpm --filter rest-api install --frozen-lockfile
    - cd rest-api && pnpm semantic-release
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "alpha"'
    - if: '$CI_COMMIT_BRANCH == "beta"'
      when: on_success

# STAGE: build
# Kaniko base template for multi-arch Docker builds
.kaniko-build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(printf '%s:%s' "${DOCKER_HUB_USER}" "${DOCKER_HUB_TOKEN}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${DOCKER_IMAGE}:${CI_COMMIT_TAG}-${ARCH}" \
        --build-arg SDK_VERSION=${SDK_VERSION} \
        --custom-platform "linux/${ARCH}" \
        --cache=true \
        --cache-repo "${DOCKER_IMAGE}/cache"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'

build-amd64:
  extends: .kaniko-build
  variables:
    ARCH: amd64
  tags:
    - kubernetes

build-arm64:
  extends: .kaniko-build
  variables:
    ARCH: arm64
  tags:
    - kubernetes

# STAGE: publish
publish:
  stage: publish
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "${DOCKER_HUB_TOKEN}" | docker login -u "${DOCKER_HUB_USER}" --password-stdin
  script:
    - |
      docker manifest create "${DOCKER_IMAGE}:${CI_COMMIT_TAG}" \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}-amd64" \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}-arm64"
    - docker manifest push "${DOCKER_IMAGE}:${CI_COMMIT_TAG}"
    - |
      docker manifest create "${DOCKER_IMAGE}:latest" \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}-amd64" \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}-arm64"
    - docker manifest push "${DOCKER_IMAGE}:latest"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
  tags:
    - kubernetes

# STAGE: scan
# Container vulnerability scanning (post-build)
container_scanning:
  extends: .trivy-base
  stage: scan
  script:
    - |
      EXIT_CODE=0
      if [ "$SECURITY_FAIL_ON_VULN" = "true" ]; then
        EXIT_CODE=1
      fi
    - |
      trivy image \
        --format template \
        --template "@/contrib/gitlab.tpl" \
        --output gl-container-scanning-report.json \
        --severity "$SECURITY_SEVERITY" \
        --exit-code $EXIT_CODE \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}"
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    when: always
    expire_in: 90 days
  rules:
    - if: $SCAN_CONTAINER == "true" && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
    - if: $SCAN_CONTAINER == "false"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "none"
      when: never
    - if: $SECURITY_SCAN_LEVEL == "minimal"
      when: never
    - if: $SECURITY_SCAN_LEVEL =~ /^(standard|full)$/ && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  tags:
    - kubernetes

# SBOM generation (optional, for future compliance)
# Enable by setting SCAN_SBOM="true" in CI/CD variables
sbom_generation:
  extends: .trivy-base
  stage: scan
  script:
    - |
      trivy image \
        --format cyclonedx \
        --output sbom.cdx.json \
        "${DOCKER_IMAGE}:${CI_COMMIT_TAG}"
  artifacts:
    paths:
      - sbom.cdx.json
    when: always
    expire_in: 90 days
  rules:
    - if: $SCAN_SBOM == "true" && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  tags:
    - kubernetes
